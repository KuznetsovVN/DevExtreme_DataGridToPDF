<!DOCTYPE html>
<html>
<head>
    <title>DevExtreme DataGrid to Excel / SheetJS</title>

    <link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/18.2.3/css/dx.common.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/18.2.3/css/dx.light.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/20.1.4/js/dx.all.debug.js"></script>

    <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script> -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.65/pdfmake.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.65/vfs_fonts.js'></script>

    <script type="text/javascript" src="../../data/employees.js"></script>

    <script src='https://cdn.jsdelivr.net/npm/html-to-pdfmake/docs/browser.js'></script>

</head>
<body>

    <h3>pdfmake with custom generated doc structure </h3>
    <p align="right">Click here<br />|| &emsp;<br />V&emsp;</p>

    <div id="gridContainer"></div>

    <script>
      (function() {

          function RGBToHex(rgb) {
              // Choose correct separator
              let sep = rgb.indexOf(",") > -1 ? "," : " ";

              if(rgb.indexOf("rgba") > -1) {
                  // Turn "rgba(r,g,b)" into [r,g,b]
                  rgb = rgb.substr(5).split(")")[0].split(sep);
              }
              else {
                  // Turn "rgba(r,g,b)" into [r,g,b]
                  rgb = rgb.substr(4).split(")")[0].split(sep);
              }

              let r = (+rgb[0]).toString(16),
                  g = (+rgb[1]).toString(16),
                  b = (+rgb[2]).toString(16);

              if (r.length == 1)
                  r = "0" + r;
              if (g.length == 1)
                  g = "0" + g;
              if (b.length == 1)
                  b = "0" + b;

              return "#" + r + g + b;
          }

        function ProcessPaddings(domElement, obj) {
            $elem = $(domElement);

            var lPaddingWidth = parseInt($elem.css("padding-left"), 10);
            var tPaddingWidth = parseInt($elem.css("padding-top"), 10);
            var rPaddingWidth = parseInt($elem.css("padding-right"), 10);
            var bPaddingWidth = parseInt($elem.css("padding-bottom"), 10);

            obj.layout = obj.layout || {};
            obj.layout.paddingLeft = function(i, node) { return lPaddingWidth; };
            obj.layout.paddingTop = function(i, node) { return tPaddingWidth; };
            obj.layout.paddingRight = function(i, node) { return rPaddingWidth; };
            obj.layout.paddingBottom = function(i, node) { return bPaddingWidth; };
        }

        function ProcessBackgroundColor(domElement, obj) {
            $elem = $(domElement);

            var rgba = $elem.css('background-color');
            if(rgba !== 'rgba(0, 0, 0, 0)') {
                var bColor = RGBToHex(rgba);
                if (bColor) {
                    obj.fillColor = bColor;
                }
            }
        }

        function ProcessFont(domElement, obj) {
            $elem = $(domElement);

            var fontFamily = $(domElement).css('font-family');
            var fontSize = parseInt($(domElement).css('font-size'), 10);

            var rgba = $elem.css('color');
            var color = (rgba !== 'rgba(0, 0, 0, 0)') ? RGBToHex(rgba) : null;

            if(fontFamily) {
                //obj.fontFamily = fontFamily;
            }
            if(fontSize) {
                obj.fontSize = fontSize;
            }
            if(color) {
                obj.color = color;
            }

            obj.bold = false;
        }

        function ProcessBordersWidth(domElement, cell) {
            cell.border = [ false, false, false, false ];

            $elem = $(domElement);

            var lBorderWidth = parseInt($elem.css("border-left-width"), 10);
            var tBorderWidth = parseInt($elem.css("border-top-width"), 10);
            var rBorderWidth = parseInt($elem.css("border-right-width"), 10);
            var bBorderWidth = parseInt($elem.css("border-bottom-width"), 10);

            if(lBorderWidth > 0 || tBorderWidth > 0 || rBorderWidth > 0 || bBorderWidth > 0) {
                cell.border = [ lBorderWidth > 0, tBorderWidth > 0, rBorderWidth > 0, bBorderWidth > 0 ];
            }
        }

        function ProcessBordersColor(domElement, obj) {
            $elem = $(domElement);

            var lBorderWidth = parseInt($elem.css("border-left-width"), 10);
            if(lBorderWidth > 0) {
                obj.layout = obj.layout || {};
                var lBorderColor = RGBToHex($elem.css("border-left-color"), 10);
                obj.layout.vLineColor = function(i, node) { return lBorderColor; };
            }

            var tBorderWidth = parseInt($elem.css("border-top-width"), 10);
            if(tBorderWidth > 0) {
                obj.layout = obj.layout || {};
                var tBorderColor = RGBToHex($elem.css("border-top-color"), 10);
                obj.layout.hLineColor = function(i, node) { return tBorderColor; };
            }
        }

        function RecursePdfGenerating(domElement) {
            if(!domElement)
                return null;

            if($(domElement).is(":hidden"))
                return null;

            var obj = {};

            obj.table = {};
            /*if(domElement.width)
                obj.table.widths = [ domElement.width ];*/
            obj.table.body = [];

            if(domElement.tagName == 'DIV' || domElement.tagName == 'SPAN') {
                ProcessPaddings(domElement, obj);
                ProcessBordersColor(domElement, obj);

                if(domElement.childNodes.length > 0) {
                    $.each(domElement.childNodes, function( index, value ) {

                        var cell = {};

                        if(value.nodeType === 3)
                            cell = { text: value.nodeValue };
                        else
                            cell = RecursePdfGenerating(value);

                        if(cell) {
                            ProcessBordersWidth(domElement, cell);
                            ProcessBackgroundColor(domElement, cell);

                            var row = [];
                            row.push(cell);
                            obj.table.body.push(row);
                        }
                    });
                }
                else {
                    obj = { text: '' };
                }
            }
            else if(domElement.tagName == 'TABLE') {
                var eTBody;
                $.each(domElement.childNodes, function( index, value ) {
                    if(value.tagName == 'COLGROUP') {
                        var row = [];
                        obj.table.body.push(row);

                        obj.table.widths = [];
                        $.each(value.childNodes, function( colIndex, colValue ) {
                            var width = $(colValue).width();
                            obj.table.widths.push(width ? width : '*');

                            row.push({
                                text: '',
                                border: [ false, false, false, false ]
                            });
                        });
                    }
                    if(value.tagName == 'TBODY') {
                        eTBody = value;
                    }
                });

                $.each(eTBody.childNodes, function( index, tr ) {
                    var row = [];

                    $.each(tr.childNodes, function( index, td ) {
                        ProcessPaddings(td, obj);
                        ProcessBordersColor(td, obj);

                        var cell = {};

                        $.each(td.childNodes, function( index, value ) {
                            if (value.nodeType === 3)
                                cell = {text: value.nodeValue};
                            else
                                cell = RecursePdfGenerating(value);
                        });

                        if(!cell || td.childNodes.length == 0)
                            cell = {text: ' '};

                        var colSpan = $(td).prop("colSpan");
                        if(colSpan && colSpan > 1) {
                            cell.colSpan = colSpan;
                        }
                        var rowSpan = $(td).prop("rowSpan");
                        if(rowSpan && rowSpan > 1) {
                            cell.rowSpan = rowSpan;
                        }

                        if(cell) {
                            ProcessBordersWidth(td, cell);

                            ProcessBackgroundColor(tr, cell);
                            ProcessBackgroundColor(td, cell);

                            ProcessFont(tr, cell);
                            ProcessFont(td, cell);

                            row.push(cell);
                        }
                    });

                    if(row)
                        obj.table.body.push(row);
                });
            }
            /*else if(domElement.tagName == 'TBODY') {
                obj = null;
            }
            else if(domElement.tagName == 'TR') {
                obj = null;
            }
            else if(domElement.tagName == 'TD') {
                obj = null;
            }*/
            else {
                obj = { text: '' };
            }
            return obj;
        }

      $('#gridContainer').dxDataGrid({
        dataSource: employees,
        showBorders: true,
        selection: { mode: 'multiple' },
        groupPanel: { visible: true },
        export: { enabled: true, allowExportSelectedData: true },
        onExporting: function(e) {

            //debugger;

            var docDefinition = {
                pageSize: 'A4',
                pageOrientation: 'landscape',
                pageMargins: [ 5, 5, 5, 5 ],
                content: [
                ],
                styles: {
                }
            };

            var obj = RecursePdfGenerating(e.component.element()[0]);
            docDefinition.content.push(obj);

            var pdf = pdfMake.createPdf(docDefinition);
            pdf.download();

            // ...
            e.cancel = true;
        },
        columns: [
          'FirstName',
          'LastName',
          'City',
          {
            dataField: 'State',
            groupIndex: 0
          }, {
            dataField: 'Position',
            width: 130
          }, {
            dataField: 'BirthDate',
            dataType: 'date',
            width: 100
          }, {
            dataField: 'HireDate',
            dataType: 'date',
            width: 100
          }
        ]
      });

      })();
    </script>

</body>
</html>
